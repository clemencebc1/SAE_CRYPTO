from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes
from cryptography.hazmat.backends import default_backend

def bitstring_to_bytes(s: str) -> bytes:
    # Convertit une chaîne de '0' et '1' en octets
    return int(s, 2).to_bytes((len(s) + 7) // 8, byteorder='big')

def decrypt_cbc(iv: bytes, key: bytes, ciphertext: bytes) -> bytes:
    # Vérification de la longueur de l'IV
    if len(iv) != 16:
        raise ValueError("L'IV doit avoir une longueur de 16 octets (128 bits).")
    if len(ciphertext) % 16 != 0:
        raise ValueError("La longueur du message chiffré doit être un multiple de 16 octets.")
    
    cipher = Cipher(algorithms.AES(key), modes.CBC(iv), backend=default_backend())
    decryptor = cipher.decryptor()
    plaintext = decryptor.update(ciphertext) + decryptor.finalize()
    return plaintext

if __name__ == "__main__":
    keys_str = "0100000000110010100010000001000000111000010011001001111000101110111110010011000101100011111011100110001000110010000111011010101110110100101000001111011100011000100111011010010000010001111111011000110110001011000110111011101111110110001000111011110111010111011000101001011101011011110001010011011011000100101011001000110001000111011001110010110101110011111100110100110100111100101000101101111011111100110000000101011000011100100010101110100110001111011000110011000100110000111110010100011011110001100011000100111011001011001100011011100001001000100010001100100001111100100100111000100110100100110011110110101100100010110100100101011011011101110001100101101000010001101101110111110100100011101111010000110110000101001100100110000110001010100111101011010001010101011111100110010110111011111101110000110100111111100111011110010111000101100001001111110010001110010110001000100100111100011110111000100010111000011000101011000111000110110010110100110100000010001001101000010001000011001100000101001110111000000111000110110101100110"
    key = keys_str[:256]
    key_bytes = bitstring_to_bytes(key)  # Conversion correcte ici

    # Premier message
    message1 = bytes.fromhex("4311799b24e1096fbfb6687af87649f5e010847a104cac93dde2c7995c5243ff28083a2fafc04f3c27be51fd6436aac6")
    IV1 = message1[:16]
    texte1 = message1[16:]
    
    print("Premier message déchiffré :")
    print(decrypt_cbc(IV1, key_bytes, texte1))
    
    # Second message
    message2 = bytes.fromhex("1147f288500b1dd47605cd84c1af4a276352ab9a3e27de5868b9dfc1d5a044d928083a2fafc04f3c27be51fd6436aac6")
    IV2 = message2[:16]
    texte2 = message2[16:]
    
    print("\nSecond message déchiffré :")
    print(decrypt_cbc(IV2, key_bytes, texte2))
